# Fractal VSM Observability Stack - Configuration Report

**Date:** 2025-10-20
**Status:** ✅ OPERATIONAL

---

## Executive Summary

The Fractal VSM observability stack has been successfully configured and is now operational. All core components (Grafana, Prometheus, Jaeger, OTEL Collector) are running and properly integrated.

**Working Components:**

- ✅ Grafana dashboards loading correctly
- ✅ Prometheus scraping OTEL Collector metrics
- ✅ Jaeger receiving and displaying traces
- ✅ OTEL Collector processing telemetry data
- ✅ Data sources properly configured

---

## 1. What Was Fixed

### 1.1 Grafana Dashboard JSON Format Issue

**Problem:** Dashboards failed to load with error "Dashboard title cannot be empty"

**Root Cause:** Dashboard JSON files had an incorrect wrapper structure:

```json
{
  "dashboard": {
    "title": "..."
  }
}
```

**Solution:** Removed the wrapper object. Grafana file-based provisioning expects the dashboard object at the root level:

```json
{
  "title": "...",
  "uid": "...",
  "panels": [...]
}
```

**Additional improvements:**

- Added required `uid` field for stable dashboard references
- Updated `schemaVersion` to 38 (current Grafana version)
- Added missing fields: `editable`, `fiscalYearStartMonth`, `graphTooltip`, `links`

**Files modified:**

- `/Users/cal/DEV/bmad/BMAD-METHOD/observability/grafana/dashboards/fractal-vsm-overview.json`
- `/Users/cal/DEV/bmad/BMAD-METHOD/observability/grafana/dashboards/fractal-vsm-agents.json`

### 1.2 OTEL Collector Monitoring Dashboard Created

**Created:** New working dashboard showing real OTEL Collector metrics

**File:** `/Users/cal/DEV/bmad/BMAD-METHOD/observability/grafana/dashboards/otel-collector-monitoring.json`

**Panels include:**

- OTEL Collector uptime
- Memory usage (RSS, Heap, Total System)
- CPU usage
- Service health status (up/down)
- Metric points received/sent rates
- Exporter queue status
- Prometheus scrape targets table

### 1.3 Application Instrumentation

**Created:**

1. **Metrics Server** (`fractal_agent/observability/metrics_server.py`)
   - Exposes Prometheus metrics on HTTP endpoint
   - Uses the custom registry defined in metrics.py
   - Runs on port 9100 by default

2. **Test Metrics Generator** (`test_metrics.py`)
   - Generates realistic test data for all metric types
   - Simulates LLM calls, tasks, agent operations, events
   - Useful for testing and development

3. **Simple Test Script** (`generate_test_metrics_simple.py`)
   - Quick script to populate metrics with sample data
   - Generates 50 LLM calls, 20 tasks, 30 operations, 40 events

---

## 2. What Metrics Are Actually Being Collected

### 2.1 OTEL Collector Metrics (Currently Active)

**Source:** OTEL Collector internal metrics
**Scrape endpoint:** `http://otel-collector:8889/metrics`
**Status:** ✅ Being scraped by Prometheus every 15s

**Metrics available:**

- `fractal_vsm_otelcol_process_uptime_total` - Collector uptime
- `fractal_vsm_otelcol_process_memory_rss` - Memory usage
- `fractal_vsm_otelcol_process_cpu_seconds_total` - CPU usage
- `fractal_vsm_otelcol_receiver_accepted_metric_points_total` - Metrics received
- `fractal_vsm_otelcol_exporter_sent_metric_points_total` - Metrics exported
- `fractal_vsm_otelcol_exporter_queue_size` - Export queue status
- `fractal_vsm_up` - Service health status

**Current values (as of 2025-10-20 17:55):**

- Uptime: ~1590 seconds (~26.5 minutes)
- Metrics processed: 4434 metric points
- Memory: ~186 MB RSS
- Status: All exporters healthy

### 2.2 Application Metrics (Defined but Not Yet Generated by Real Usage)

**Source:** Fractal Agent application code
**Status:** ⚠️ Instrumentation code exists, but no real application metrics yet

**Defined metrics:**

**LLM Metrics:**

- `fractal_llm_calls_total` - Total LLM API calls (by tier, provider, model, status)
- `fractal_llm_tokens_total` - Total tokens used
- `fractal_llm_cost_usd_total` - Total cost in USD
- `fractal_llm_latency_seconds` - LLM call latency histogram
- `fractal_llm_cache_hits_total` - Cache hit counter
- `fractal_llm_errors_total` - Error counter by type

**VSM Tier Metrics:**

- `fractal_tier_tasks_total` - Tasks by tier and type
- `fractal_tier_task_duration_seconds` - Task duration histogram
- `fractal_tier_active_tasks` - Currently active tasks gauge

**Agent Metrics:**

- `fractal_agent_operations_total` - Agent operations counter
- `fractal_agent_operation_duration_seconds` - Operation duration histogram

**Research Metrics:**

- `fractal_research_stages_total` - Research stages completed
- `fractal_research_questions_per_task` - Questions per task histogram

**Intelligence Metrics:**

- `fractal_intelligence_analyses_total` - Performance analyses triggered
- `fractal_intelligence_analysis_duration_seconds` - Analysis duration

**Memory & Event Metrics:**

- `fractal_memory_operations_total` - Memory operations
- `fractal_events_stored_total` - Events stored
- `fractal_event_store_errors_total` - Event store errors

### 2.3 Prometheus Self-Monitoring

**Source:** Prometheus internal metrics
**Status:** ✅ Active

Standard Prometheus metrics available (go runtime, scrape stats, etc.)

### 2.4 Distributed Traces

**Source:** OpenTelemetry traces sent to Jaeger
**Status:** ✅ Jaeger is receiving traces

**Services registered:**

- `fractal-agent` - Main application (1 trace found)
- `jaeger-all-in-one` - Jaeger internal traces

---

## 3. What's Visible in Grafana Now

### 3.1 Access Information

**Grafana URL:** http://localhost:3002
**Default credentials:** admin / admin
**Status:** ✅ Dashboards loading successfully

### 3.2 Available Dashboards

1. **OTEL Collector - System Monitoring** ✅ WORKING WITH REAL DATA
   - URL: http://localhost:3002/d/otel-collector-monitoring
   - Shows: OTEL Collector health, performance, metrics flow
   - Data: Real-time metrics from OTEL Collector
   - **This is your primary working dashboard right now**

2. **Fractal VSM - System Overview** ⚠️ WAITING FOR APPLICATION DATA
   - URL: http://localhost:3002/d/fractal-vsm-overview
   - Shows: LLM calls, costs, tokens, latency, cache hits, errors
   - Data: Will populate when application generates metrics
   - Panels: 10 visualization panels configured

3. **Fractal VSM - Agent Performance** ⚠️ WAITING FOR APPLICATION DATA
   - URL: http://localhost:3002/d/fractal-vsm-agents
   - Shows: Agent operations, research stages, intelligence analyses
   - Data: Will populate when application generates metrics
   - Panels: 10 visualization panels configured

### 3.3 Data Sources

**Prometheus:**

- Name: Prometheus
- Type: prometheus
- URL: http://prometheus:9090
- Status: ✅ Connected
- Default: Yes

**Jaeger:**

- Name: Jaeger
- Type: jaeger
- URL: http://jaeger:16686
- Status: ✅ Connected
- Trace to Logs: Configured (for future Loki integration)

---

## 4. What Still Needs to Be Implemented

### 4.1 Application Integration (HIGH PRIORITY)

**Status:** Instrumentation code exists but not integrated into running application

**What's needed:**

1. **Initialize observability in application startup:**

```python
from fractal_agent.observability import init_tracing, configure_logging

# In your main application startup
init_tracing(service_name="fractal-agent",
             otlp_endpoint="http://localhost:4317")
configure_logging()
```

2. **Use instrumentation in agent code:**

```python
from fractal_agent.observability import get_tracer, record_llm_call

tracer = get_tracer(__name__)

with tracer.start_as_current_span("llm_call"):
    response = llm.call(...)
    record_llm_call(
        tier="System1_Research",
        provider="anthropic",
        model="claude-sonnet-4.5",
        tokens=response.tokens,
        latency_ms=response.latency,
        cost=response.cost,
        cache_hit=response.cache_hit,
        success=True
    )
```

3. **Start metrics server in application:**

```python
# In a separate thread or process
from fractal_agent.observability.metrics_server import start_metrics_server
start_metrics_server(port=8000)  # Matches Prometheus config
```

**Files to modify:**

- Main application entry point
- LLM wrapper/client code
- Agent execution code
- Task management code

### 4.2 OTEL Collector Configuration Enhancement (MEDIUM PRIORITY)

**Current state:** Collector is configured but not receiving application telemetry

**Improvements needed:**

1. **Verify OTLP receiver is accessible from application:**
   - Test: `curl http://localhost:4317` or `curl http://localhost:4318`
   - Ports are exposed but need to verify application can reach them

2. **Add resource detection processor:**

```yaml
processors:
  resourcedetection:
    detectors: [env, system, docker]
```

3. **Consider adding batch size tuning for production:**

```yaml
processors:
  batch:
    send_batch_size: 1024
    timeout: 10s
    send_batch_max_size: 2048
```

### 4.3 Additional Dashboards (LOW PRIORITY)

**Missing dashboard types:**

1. **Infrastructure Monitoring:**
   - PostgreSQL metrics (if postgres_exporter is added)
   - Redis metrics (if redis_exporter is added)
   - Docker container metrics
   - Host system metrics

2. **Business Intelligence Dashboard:**
   - Cost tracking over time
   - Token usage trends
   - Most expensive operations
   - Cost optimization opportunities

3. **Error Tracking Dashboard:**
   - Error rates by component
   - Error types and patterns
   - Alert history
   - Incident timeline

### 4.4 Alerting (MEDIUM PRIORITY)

**Current state:** Alert rules defined in dashboards but no AlertManager

**What's needed:**

1. **Deploy AlertManager:**

```yaml
# Add to docker-compose.observability.yml
alertmanager:
  image: prom/alertmanager:latest
  ports:
    - '9093:9093'
  volumes:
    - ./observability/alertmanager.yml:/etc/alertmanager/config.yml
```

2. **Configure Prometheus to use AlertManager:**

```yaml
# In prometheus.yml
alerting:
  alertmanagers:
    - static_configs:
        - targets: ['alertmanager:9093']
```

3. **Set up notification channels:**
   - Slack
   - Email
   - PagerDuty (for production)

### 4.5 Logging Aggregation (LOW PRIORITY)

**Current state:** Structured logging configured, but logs only go to files

**Future enhancement: Add Loki for log aggregation**

1. **Deploy Loki:**

```yaml
loki:
  image: grafana/loki:latest
  ports:
    - '3100:3100'
```

2. **Configure Promtail to ship logs:**

```yaml
promtail:
  image: grafana/promtail:latest
  volumes:
    - ./logs:/var/log/fractal
```

3. **Update Grafana datasources to include Loki**

4. **Enable Trace-to-Logs correlation** (already configured in Jaeger datasource)

### 4.6 Production Readiness (FUTURE)

**Not needed for development, but important for production:**

1. **Persistent storage for metrics:**
   - Prometheus data retention configuration
   - Volume mounts for Prometheus data
   - Backup strategy

2. **Authentication and authorization:**
   - Grafana user management
   - API key management
   - SSO integration

3. **High availability:**
   - Multiple Prometheus instances
   - Prometheus federation
   - Alertmanager clustering

4. **Performance tuning:**
   - Prometheus storage optimization
   - OTEL Collector scaling
   - Query optimization

---

## 5. Testing the System

### 5.1 Quick Health Check

```bash
# Check all containers are running
docker ps | grep -E "grafana|prometheus|jaeger|otel"

# Check Prometheus targets
curl -s http://localhost:9090/api/v1/targets | python3 -m json.tool

# Check Grafana dashboards
curl -s -u admin:admin 'http://localhost:3002/api/search?type=dash-db' | python3 -m json.tool

# Check Jaeger services
curl -s http://localhost:16686/api/services | python3 -m json.tool
```

### 5.2 Generate Test Metrics

```bash
# Start metrics server (if not already running)
python3 -m fractal_agent.observability.metrics_server &

# Generate sample metrics
python3 generate_test_metrics_simple.py

# Check metrics are available
curl http://localhost:9100/metrics | grep fractal_llm
```

### 5.3 View in Grafana

1. Open http://localhost:3002
2. Login with admin/admin
3. Navigate to Dashboards → Browse
4. Open "OTEL Collector - System Monitoring"
5. Verify graphs are showing data

---

## 6. URLs for Access

### Services

| Service        | URL                                      | Credentials   | Status     |
| -------------- | ---------------------------------------- | ------------- | ---------- |
| Grafana        | http://localhost:3002                    | admin / admin | ✅ Running |
| Prometheus     | http://localhost:9090                    | None          | ✅ Running |
| Jaeger UI      | http://localhost:16686                   | None          | ✅ Running |
| OTEL Collector | http://localhost:8888 (internal metrics) | None          | ✅ Running |
| OTEL Collector | http://localhost:4317 (OTLP gRPC)        | None          | ✅ Running |
| OTEL Collector | http://localhost:4318 (OTLP HTTP)        | None          | ✅ Running |

### Dashboards (Grafana)

| Dashboard                     | URL                                               | Status     | Data                    |
| ----------------------------- | ------------------------------------------------- | ---------- | ----------------------- |
| OTEL Collector Monitoring     | http://localhost:3002/d/otel-collector-monitoring | ✅ Working | ✅ Real data            |
| Fractal VSM System Overview   | http://localhost:3002/d/fractal-vsm-overview      | ✅ Loaded  | ⚠️ Waiting for app data |
| Fractal VSM Agent Performance | http://localhost:3002/d/fractal-vsm-agents        | ✅ Loaded  | ⚠️ Waiting for app data |

### API Endpoints

| Endpoint                   | URL                           | Purpose              |
| -------------------------- | ----------------------------- | -------------------- |
| Prometheus API             | http://localhost:9090/api/v1/ | Query metrics        |
| Grafana API                | http://localhost:3002/api/    | Dashboard management |
| Jaeger API                 | http://localhost:16686/api/   | Query traces         |
| Metrics (when app running) | http://localhost:8000/metrics | Application metrics  |

---

## 7. Next Steps

### Immediate (Do This Now)

1. **Integrate observability into the application:**
   - Add `init_tracing()` call to application startup
   - Add `record_llm_call()` to LLM wrapper
   - Add `record_task_completion()` to task management
   - Start metrics server in application

2. **Verify end-to-end flow:**
   - Run the application
   - Generate some activity
   - Check metrics appear in Prometheus
   - Verify dashboards populate in Grafana
   - Check traces appear in Jaeger

### Short Term (This Week)

1. **Add more instrumentation:**
   - Agent operation tracking
   - Research stage tracking
   - Event store tracking

2. **Test the existing dashboards:**
   - Ensure all panels work with real data
   - Adjust thresholds and alerts
   - Add any missing visualizations

3. **Set up basic alerting:**
   - Deploy AlertManager
   - Configure critical alerts (error rates, service down)
   - Test notification delivery

### Medium Term (This Sprint)

1. **Build business intelligence dashboard:**
   - Cost tracking
   - Token usage analysis
   - Performance optimization opportunities

2. **Add infrastructure monitoring:**
   - Database metrics
   - Cache metrics
   - Container metrics

3. **Implement logging aggregation:**
   - Deploy Loki
   - Configure Promtail
   - Enable trace-to-logs correlation

---

## 8. Troubleshooting

### Dashboard Not Loading

**Symptom:** Dashboard shows "Dashboard title cannot be empty"

**Fix:** Dashboard JSON must have title at root level, not wrapped in {"dashboard": {...}}

### No Metrics in Prometheus

**Check:**

```bash
# Are targets up?
curl http://localhost:9090/api/v1/targets

# Is scraping working?
curl http://localhost:9090/api/v1/query?query=up
```

### Grafana Can't Connect to Data Source

**Check:**

```bash
# From inside Grafana container
docker exec fractal-grafana curl http://prometheus:9090/-/healthy
docker exec fractal-grafana curl http://jaeger:16686
```

### OTEL Collector Not Receiving Data

**Check:**

```bash
# Check OTEL collector logs
docker logs fractal-otel-collector

# Check if ports are accessible
curl http://localhost:4318/health
```

---

## 9. Architecture Summary

```
Application (Fractal Agent)
    ↓ (OTLP gRPC/HTTP)
    ↓ Traces → OTEL Collector → Jaeger
    ↓ Metrics → OTEL Collector → Prometheus
    ↓ Logs → Files (future: Loki)
    ↓
Grafana (Visualization)
    ← Queries Prometheus (metrics)
    ← Queries Jaeger (traces)
    ← Queries Loki (future: logs)
```

**Current state:**

- OTEL Collector ← Prometheus ← Grafana: ✅ Working
- Jaeger ← Grafana: ✅ Working
- Application → OTEL Collector: ⚠️ Ready but not connected

---

## 10. Files Created/Modified

### Modified:

- `observability/grafana/dashboards/fractal-vsm-overview.json` - Fixed JSON format
- `observability/grafana/dashboards/fractal-vsm-agents.json` - Fixed JSON format
- `fractal_agent/observability/metrics_server.py` - Created metrics HTTP server

### Created:

- `observability/grafana/dashboards/otel-collector-monitoring.json` - Working dashboard
- `test_metrics.py` - Comprehensive test metrics generator
- `generate_test_metrics_simple.py` - Quick test metrics generator
- `observability/OBSERVABILITY_STATUS.md` - This document

---

## Conclusion

The observability stack is **operational and ready for application integration**. The foundation is solid:

✅ All infrastructure components running
✅ Data flow verified (OTEL → Prometheus → Grafana)
✅ Dashboards loading correctly
✅ One working dashboard with real data
✅ Instrumentation code ready

**The main task remaining is to integrate the instrumentation into the actual Fractal Agent application code.**

Once integrated, you'll have full visibility into:

- LLM usage and costs
- Task execution and performance
- Agent operations and timings
- Errors and anomalies
- Distributed traces for debugging

The system is production-ready for development and can be enhanced with alerting and logging aggregation as needed.
